---
title: "Functionalizing Rasters from NEON"
author: "Holly Andrews"
date: "June 21, 2016"
output: html_document
---

## Objectives


Start by putting up objectives/tasks that students will be working though:
1. Import a raster — A lidar canopy height model (lidar/Teak_lidarCHM.tif)
For the CHM, set values == 0 to NA (not trees)
1. Classify the raster according to some distribution – low medium and tall trees. This could be done using a histogram potentially or we could just decide that <2m is generally grasses / understory, <6m small trees,and the rest are tall trees. A function could import the desired thresholds. Visualize histogram/density and plot vertical cutoff lines.
1. Take the chm and create a hillshade (http://neon-workwithdata.github.io/neon-data-institute-2016/R/create-hillshade-R/)
1. PLOT - layer the classified raster on top of the hillshade, add a legend for each “class” - legends are super tricky to simplifying this process with a function would be good.  see: http://neon-workwithdata.github.io/neon-data-institute-2016/R/classify-by-threshold-R/  for my take on forcing a legend outside of the plot area using par settings. You may have other better forms of magic to make this work well. :)
1. Export the plot figure to a pdf – publishable
1. Export the classified raster as a geotiff with NaFlagg = -9999 to an outputs folder.

```{r import-raster}
library(raster)
chm <- raster("../NEONdata/D17-California/TEAK/2013/lidar/TEAK_lidarCHM.tif")
chm[chm==0] <- NA
```

```{r classify-raster}
hist(chm)
density(chm)

abline(v=6)
abline(v=10)

class.chm <- c(0,6,1,6.00000001,10,2,10.000000001,60,3)
rcl.chm <- matrix(class.chm, ncol=3, byrow=TRUE)
chm.ns <- reclassify(chm,rcl.chm)
hist(chm.ns)
density(chm,main="CHM density with breaks")
abline(v=rcl.chm[,2],col="red")
```

```{r plot-chm}
par(xpd=FALSE,mar=c(5.1,4.1,4.1,4.5))
plot(chm.ns, col=c("brown","blue","green"),main="TEAK CHM",legend=FALSE)
par(xpd=TRUE)
legend((par()$usr[2] + 20), 4103300,  # set x,y legend location
       legend = c("Understory", "Small","Tall"),  # make sure the order matches the colors, next
       fill = c("brown", "blue","green"),
       bty="n") # turn off border
```

```{r export-density-to-pdf}
pdf(file="TEAK_CHM_density_with_breaks.pdf",width=6,height=7)
density(chm,main="fdsakltj")
abline(v=rcl.chm[,2],col="red")
```

